---

 - hosts: zabbix-agent
   become: yes
   tasks:

   - name: CentOS Install zabbix-agent
     command: "{{ item }}"
     with_items:
     - rpm -Uvh https://repo.zabbix.com/zabbix/5.4/rhel/8/x86_64/zabbix-release-5.4-1.el8.noarch.rpm --replacepkgs
     - dnf clean all
     - dnf install zabbix-agent -y
     - systemctl stop zabbix-agent.service
     when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

   - name: Ubuntu Install zabbix-agent
     command: "{{ item }}"
     with_items:
     - wget https://repo.zabbix.com/zabbix/5.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_5.4-1+ubuntu20.04_all.deb
     - dpkg -i zabbix-release_5.4-1+ubuntu20.04_all.deb
     - apt update
     - apt install zabbix-agent -y
     - rm -rf zabbix-release_5.4-1+ubuntu20.04_all.deb
     - systemctl stop zabbix-agent.service
     when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

   - name: Replace config
     template:
       src: /etc/ansible/common/files/zabbix_agentd.conf
       dest: /etc/zabbix/zabbix_agentd.conf

   - name: zabbix-agent systemd
     systemd:
       name: zabbix-agent
       enabled: yes
       state: started
